pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    parameters {
        string(name: 'MLFLOW_TRACKING_URI', defaultValue: '', description: 'Override MLflow tracking URI (optional).')
        string(name: 'MLFLOW_EXPERIMENT_NAME', defaultValue: 'jenkins-mlflow-demo', description: 'Target MLflow experiment.')
        string(name: 'MAX_ITER', defaultValue: '200', description: 'max_iter parameter for LogisticRegression.')
        booleanParam(name: 'USE_MLFLOW_PROJECT', defaultValue: false, description: 'Enable to execute via `mlflow run .` instead of python train.py')
        booleanParam(name: 'RUN_SECURITY_SCANS', defaultValue: true, description: 'Run pip-audit and bandit before training.')
        booleanParam(name: 'RUN_MS_SECURITY', defaultValue: false, description: 'Run Microsoft Security DevOps (CredScan/DevSkim/Bandit) if msdo is available.')
        booleanParam(name: 'RUN_GARAK', defaultValue: false, description: 'Run garak red-team probes (requires model/args).')
        string(name: 'GARAK_COMMAND', defaultValue: '', description: 'Full garak CLI arguments, e.g. \"--model openai:gpt-4o-mini --n-probes 10 --report garak_report.json\". Leave empty to skip.')
        booleanParam(name: 'RUN_FAIRLEARN', defaultValue: false, description: 'Run Fairlearn bias snapshot after training.')
        booleanParam(name: 'RUN_GISKARD', defaultValue: false, description: 'Run Giskard scan after training.')
        booleanParam(name: 'RUN_CREDO_AI', defaultValue: false, description: 'Capture Credo AI metadata after training.')
        booleanParam(name: 'RUN_CYCLONEDX', defaultValue: false, description: 'Generate CycloneDX SBOM for dependencies.')
    }

    environment {
        VENV_DIR = "${env.WORKSPACE}\\.venv"
        PYTHON = "${env.WORKSPACE}\\.venv\\Scripts\\python.exe"
        PIP = "${env.WORKSPACE}\\.venv\\Scripts\\pip.exe"
    }

    stages {
        stage('Python Environment') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    python -m venv "$env:VENV_DIR"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    python -m pip install --upgrade pip
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install -r requirements.txt
                '''
            }
        }

        stage('Security Scan') {
            when {
                expression { params.RUN_SECURITY_SCANS }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install -r requirements-security.txt
                    # Run pip-audit; allow exit code 1 (vulnerabilities found) but fail on other errors.
                    pip-audit -r requirements.txt --format json --output pip-audit.json
                    if ($LASTEXITCODE -eq 1) {
                        Write-Host "pip-audit found vulnerabilities; marking as warning but continuing build"
                        $global:LASTEXITCODE = 0
                    } elseif ($LASTEXITCODE -ne 0) {
                        throw "pip-audit failed with exit code $LASTEXITCODE"
                    }
                    bandit -r . -x .venv -ll -iii -f json -o bandit.json
                '''
            }
        }

        stage('MS Security DevOps (optional)') {
            when {
                expression { params.RUN_MS_SECURITY }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    if (-not (Get-Command msdo -ErrorAction SilentlyContinue)) {
                        Write-Warning "msdo not found on PATH; skipping Microsoft Security DevOps tools run."
                        exit 0
                    }
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    msdo run --tools "credscan,devskim,bandit" --output-format sarif --output-path msdo.sarif
                    if ($LASTEXITCODE -ne 0) {
                        Write-Warning "msdo returned exit code $LASTEXITCODE; marking build as failed for visibility."
                        exit $LASTEXITCODE
                    }
                '''
            }
        }

        stage('Garak Red Team (optional)') {
            when {
                expression { params.RUN_GARAK }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    if ([string]::IsNullOrEmpty($env:GARAK_COMMAND)) {
                        Write-Host "GARAK_COMMAND is empty; skipping garak run."
                        exit 0
                    }
                    & "$env:PIP" install garak
                    $cmdArgs = $env:GARAK_COMMAND -split '\\s+'
                    Write-Host "Running garak with args: $cmdArgs"
                    garak @cmdArgs
                '''
            }
        }

        stage('Train & Log to MLflow') {
            steps {
                script {
                    String trackingUri = params.MLFLOW_TRACKING_URI?.trim()
                    if (!trackingUri) {
                        trackingUri = env.MLFLOW_TRACKING_URI ?: ''
                    }

                    String experimentName = params.MLFLOW_EXPERIMENT_NAME?.trim()
                    if (!experimentName) {
                        experimentName = env.MLFLOW_EXPERIMENT_NAME ?: 'jenkins-mlflow-demo'
                    }

                    String maxIter = params.MAX_ITER?.trim()
                    if (!maxIter) {
                        maxIter = '200'
                    }

                    withEnv([
                        "TRACKING_URI=${trackingUri}",
                        "EXPERIMENT_NAME=${experimentName}",
                        "MAX_ITER=${maxIter}",
                        "USE_MLFLOW_PROJECT=${params.USE_MLFLOW_PROJECT}",
                        "MLFLOW_ENV_MANAGER=local",
                    ]) {
                        powershell '''
                            $ErrorActionPreference = "Stop"
                            & "$env:VENV_DIR\\Scripts\\Activate.ps1"

                            if (![string]::IsNullOrEmpty($env:TRACKING_URI)) {
                                $env:MLFLOW_TRACKING_URI = $env:TRACKING_URI
                            }

                            if (![string]::IsNullOrEmpty($env:MLFLOW_TRACKING_TOKEN)) {
                                $env:MLFLOW_TRACKING_TOKEN = $env:MLFLOW_TRACKING_TOKEN
                            }

                            if ($env:USE_MLFLOW_PROJECT -eq "true") {
                                mlflow run . `
                                    -P max_iter=$env:MAX_ITER `
                                    -P experiment_name=$env:EXPERIMENT_NAME
                            }
                            else {
                                dvc params modify train.max_iter $env:MAX_ITER
                                dvc params modify train.experiment_name $env:EXPERIMENT_NAME
                                dvc repro
                            }
                        '''
                    }
                }
            }
        }

        stage('Fairlearn Bias Check (optional)') {
            when {
                expression { params.RUN_FAIRLEARN }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install fairlearn
                    python audit_tools.py --run-fairlearn
                '''
            }
        }

        stage('Giskard QA (optional)') {
            when {
                expression { params.RUN_GISKARD }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install giskard
                    python audit_tools.py --run-giskard
                '''
            }
        }

        stage('Credo AI Metadata (optional)') {
            when {
                expression { params.RUN_CREDO_AI }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install credoai
                    python audit_tools.py --run-credo
                '''
            }
        }

        stage('CycloneDX SBOM (optional)') {
            when {
                expression { params.RUN_CYCLONEDX }
            }
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    & "$env:VENV_DIR\\Scripts\\Activate.ps1"
                    & "$env:PIP" install cyclonedx-bom
                    if (-not (Test-Path artifacts)) { New-Item -ItemType Directory -Path artifacts | Out-Null }
                    if (Get-Command cyclonedx-py -ErrorAction SilentlyContinue) {
                        cyclonedx-py -j -r requirements.txt -o artifacts/cyclonedx-sbom.json
                    } elseif (Get-Command cyclonedx-bom -ErrorAction SilentlyContinue) {
                        cyclonedx-bom -j -r requirements.txt -o artifacts/cyclonedx-sbom.json
                    } else {
                        throw "CycloneDX CLI not found after install."
                    }
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'mlruns_local/**,pip-audit.json,bandit.json,msdo.sarif,garak_report.*,artifacts/fairlearn_report.json,artifacts/giskard_report.*,artifacts/credoai_report.json,artifacts/cyclonedx-sbom.json', allowEmptyArchive: true, fingerprint: true
        }
    }
}
